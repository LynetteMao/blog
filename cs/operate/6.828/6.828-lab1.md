---
title: PC Bootstrap and GCC Calling Conventions
date: 2018-10-16 08:28:07
tags: 6.828;ç¯å¢ƒæ­å»º
categories: operate
toc: true
---

# Lab 1ï¼šPC Bootstrap and GCC Calling Conventions

## ä¸€ã€x86æ±‡ç¼–è¯­è¨€ï¼ŒQEMU x86ä»¿çœŸå™¨ï¼ŒPCå¯åŠ¨

1. å‡†å¤‡lab

   ```shell
   athena% mkdir ~/6.828
   athena% cd ~/6.828
   athena% add git
   # å› ä¸ºæ˜¯å¢™å¤–çš„ï¼Œæ‰€ä»¥è¦ä½¿ç”¨ä»£ç†
   athena% proxychains4 git clone https://pdos.csail.mit.edu/6.828/2018/jos.git lab
   Cloning into lab...
   athena% cd lab
   ```

2. æäº¤ä½œä¸š

   make handinæ˜¯æŠŠä½œä¸šæäº¤è‡³6.828çš„ä¸€ä¸ªä¸“é—¨çš„ä½œä¸šæäº¤ç½‘ç«™ï¼Œè®°å½•ä½œä¸šå®Œæˆçš„æƒ…å†µåŠå¯¹ç¨‹åºè¿›è¡Œè¯„åˆ†ï¼Œè¿›å…¥[submission website](https://6828.scripts.mit.edu/2018/handin.py/)ç”³è¯·ï¼Œä¼šå‘é€é‚®ä»¶ï¼Œå¤åˆ¶é‡Œé¢çš„API key

   ``` shell
   athena% git commit -am "ready to submit my lab"
   [lab1 c2e3c8b] ready to submit my lab
    2 files changed, 18 insertions(+), 2 deletions(-)
   
   athena% make handin
   git archive --prefix=lab1/ --format=tar HEAD | gzip > lab1-handin.tar.gz
   Get an API key for yourself by visiting https://6828.scripts.mit.edu/2018/handin.py/
   Please enter your API key: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
     % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                    Dload  Upload   Total   Spent    Left  Speed
   100 50199  100   241  100 49958    414  85824 --:--:-- --:--:-- --:--:-- 85986
   athena%
   ```

   å¯ä»¥è¿è¡Œ`make grade`æ¥è¯„åˆ†ç¨‹åº.

### Part1ï¼šPC Bootstrap

1. å¯åŠ¨

   ```shell
   make
   make qemu
   ```

   è·å–kernelç›‘è§†å™¨

   ```shell
   K> help
   help - display this list of commands
   kerninfo - display information about the kernel
   K> kerninfo
   Special kernel symbols:
     entry  f010000c (virt)  0010000c (phys)
     etext  f0101a75 (virt)  00101a75 (phys)
     edata  f0112300 (virt)  00112300 (phys)
     end    f0112960 (virt)  00112960 (phys)
   Kernel executable memory footprint: 75KB
   K>
   ```

   > Although simple, it's important to note that this kernel monitor is running "directly" on the "raw (virtual) hardware" of the simulated PC. This means that you should be able to copy the contents of `obj/kern/kernel.img` onto the first few sectors of a *real* hard disk, insert that hard disk into a real PC, turn it on, and see exactly the same thing on the PC's real screen as you did above in the QEMU window. (We don't recommend you do this on a real machine with useful information on its hard disk, though, because copying `kernel.img` onto the beginning of its hard disk will trash the master boot record and the beginning of the first partition, effectively causing everything previously on the hard disk to be lost!)

1. PCç‰©ç†åœ°å€ç©ºé—´

![pysicalAddress](http://prdj7tprx.bkt.clouddn.com/pysicalAddress.png)

1. The ROM BIOS

   ä½¿ç”¨QEMUè°ƒè¯•å·¥å…·æ¥ç ”ç©¶IA-32å…¼å®¹è®¡ç®—æœºçš„å¯åŠ¨æ–¹å¼

   ```shell
   make qemu-gdb
   make gdb
   GNU gdb (GDB) 6.8-debian
   Copyright (C) 2008 Free Software Foundation, Inc.
   License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
   This is free software: you are free to change and redistribute it.
   There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
   and "show warranty" for details.
   This GDB was configured as "i486-linux-gnu".
   + target remote localhost:26000
   The target architecture is assumed to be i8086
   [f000:fff0] 0xffff0:	ljmp   $0xf000,$0xe05b
   0x0000fff0 in ?? ()
   + symbol-file obj/kern/kernel
   (gdb) 
   ```

   å¯åŠ¨ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„æ˜¯ä¸€ä¸ªjmpçš„æŒ‡ä»¤ï¼ŒPCå¼€å§‹çš„æ‰§è¡Œçš„ç‰©ç†åœ°å€ä¸º`CS = 0xf000` and `IP = 0xfff0`ï¼Œè·³è½¬è‡³``$0xf000,$0xe05b`` ï¼Œå³ç‰©ç†åœ°å€ä¸º

   ```
    16 * 0xf000 + 0xfff0   # in hex multiplication by 16 is
      = 0xf0000 + 0xfff0     # easy--just append a 0.
      = 0xffff0 
      
    16 * 0xf000 + 0xe05b
      = 0xf0000+0xe05b
      = 0xfe05b
   ```

   0xffff0åœ¨BIOSå†…(4GB)çš„æœ«å°¾ä½ç½®ï¼Œ0xfe05bæ¯”0xffff0æ›´å°ï¼Œä¸ºä»€ä¹ˆä¼šå¾€æ›´ä½çš„åœ°å€jmpï¼Ÿ

   å› ä¸ºè¦åœ¨16å­—èŠ‚å®Œæˆè¿™ä¸€ç³»åˆ—çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¦è¿›è¡Œå›é€€ã€‚

   æ³¨ï¼š16å­—èŠ‚å³128ä½ï¼Œæ¢ç®—æˆ16è¿›åˆ¶ï¼Œå³8ä½ï¼Œå³4GBï¼Œå³BIOSæ€»å¤§å°ã€‚

2. åŸºç¡€çŸ¥è¯†æ‰©å……

   - ROM Memory

     Read Only Memory,ä¸å¯é€šè¿‡è½¯ä»¶æ”¹å†™ï¼Œè€Œä¸”ä¸ä½œä¸ºå·¥ä½œç©ºé—´ï¼Œä¸»è¦ç”¨äºBIOS

   - å¦‚ä½•è°ƒè¯•jos

     `c` ç»§ç»­æ‰§è¡Œ

     `si`é€æ­¥è°ƒè¯•


3. è°ƒè¯•åˆ†æ

   ```shell
   (gdb) si
   [f000:e05b]    0xfe05b:    cmpl   $0x0,%cs:0x6ac8
   0x0000e05b in ?? ()
   ```

### Part2ï¼šThe Boot Loader

#### åŸºç¡€çŸ¥è¯†

ç£ç›˜ï¼š

![600px-Disk-structure2.svg](http://prdj7tprx.bkt.clouddn.com/600px-Disk-structure2.svg.png)

A:åŒå¿ƒåœ†ä¸ºç£é“(track)

B:æ‰‡é¢

C:sectors-æ‰‡åŒº(æ‰‡é“å’Œæ‰‡é¢é‡åˆçš„åœ°æ–¹) é€šå¸¸ä¸º512byte

- æ‰‡åŒºï¼šæ‰‡åŒºæ˜¯ç£ç›˜è¯»å†™çš„æœ€å°å•ä½

å¦‚æœç£ç›˜æ˜¯å¯å¯åŠ¨çš„ï¼Œç¬¬ä¸€ä¸ªæ‰‡åŒºç§°ä¸ºboot sectorï¼Œè¿™æ˜¯å¼•å¯¼åŠ è½½ç¨‹åºé©»ç•™çš„ä»£ç ã€‚å½“BIOSæ‰¾åˆ°å¯å¯åŠ¨çš„è½¯ç›˜æˆ–ç¡¬ç›˜æ—¶ï¼ŒåŠ è½½512å­—èŠ‚çš„æ‰‡åŒºåˆ°ä¸»å­˜åœ¨ç‰©ç†åœ°å€0x7c00åˆ°0x7dffï¼Œç„¶åä½¿ç”¨jmpè®¾ç½®CS:IP 0000:7c00 ,å°†æ§åˆ¶å™¨è½¬ç»™å¯åŠ¨å¼•å¯¼ã€‚ä¸ BIOS åŠ è½½åœ°å€ç±»ä¼¼, è¿™äº›åœ°å€æ˜¯ç›¸å½“ä»»æ„çš„-ä½†å®ƒä»¬æ˜¯å›ºå®šçš„, å¹¶ä¸”æ ‡å‡†åŒ–çš„ pcã€‚

- Real Mode(å®æ¨¡å¼)

å†…å­˜è¢«é™åˆ¶åœ¨2çš„20æ¬¡æ–¹ï¼Œå³1Mï¼Œè½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼Œå³è¦æœ‰20ä½çš„æ•°å­—ï¼Œä½†æ˜¯å¯„å­˜å™¨åªæœ‰16ä½ï¼Œæ‰€ä»¥å°±ç”¨ä¸¤ä¸ªå¯„å­˜å™¨æ¥è¡¨ç¤ºä¸€ä¸ªåœ°å€ï¼Œä¸€ä¸ªè¡¨ç¤ºæ®µåœ°å€ï¼Œä¸€ä¸ªè¡¨ç¤ºåç§»åœ°å€ï¼Œå³`16*selector+offset`

- 16-bit Protected Mode(16ä½ä¿æŠ¤æ¨¡å¼)

åœ¨16ä½ä¿æŠ¤æ¨¡å¼ï¼Œselectorçš„å€¼çš„è§£æä¸å®æ¨¡å¼çš„å®Œå…¨ä¸ä¸€æ ·ï¼Œåœ¨å®æ¨¡å¼é‡Œé¢selectorçš„å€¼æ˜¯ç‰©ç†å†…å­˜ï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ï¼Œselectorçš„å€¼æ˜¯ä¸€ä¸ªç´¢å¼•åœ¨descriptor tableã€‚åœ¨è¿™ä¸¤ç§æ¨¡å¼ä¸­ï¼Œç¨‹åºéƒ½è¿›è¡Œäº†åˆ†æ®µï¼Œåœ¨å®æ¨¡å¼é‡Œé¢ï¼Œè¿™äº›æ®µåœ¨ç‰©ç†å†…å­˜é‡Œéƒ½æ˜¯å›ºå®šä½ç½®çš„ï¼Œselectorçš„å€¼æ˜¯è¿™ä¸ªæ®µçš„èµ·å§‹ä½ç½®ã€‚åœ¨ä¿æŠ¤æ¨¡å¼ï¼Œåœ¨ç‰©ç†å†…å­˜é‡Œæ²¡æœ‰å›ºå®šçš„ä½ç½®ï¼Œå®é™…ä¸Šï¼Œä»–ä»¬æ ¹æœ¬ä¸å¿…åœ¨å†…å­˜é‡Œï¼ï¼ï¼

ä¿æŠ¤æ¨¡å¼ä½¿ç”¨çš„æŠ€æœ¯å«åšè™šæ‹Ÿå†…å­˜ï¼Œåªè¦ä¿è¯æ­£åœ¨è¿è¡Œçš„ç¨‹åºåœ¨å†…å­˜ä¸­å°±è¡Œäº†ï¼Œå…¶ä»–æ•°æ®å’Œä»£ç ä¸´æ—¶å­˜å‚¨åœ¨ç£ç›˜é‡Œï¼ŒçŸ¥é“è¦ç”¨ä¸ºæ­¢ã€‚

åŠ£åŠ¿ï¼šåç§»é‡åªæœ‰16ä½ï¼Œå› æ­¤æ®µçš„å¤§å°é™åˆ¶åœ¨64K.

- 32-bit Protected Mode(32ä½ä¿æŠ¤æ¨¡å¼)
  å’Œ16ä½ä¿æŠ¤æ¨¡å¼ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç‚¹åŒºåˆ«:
  1. åç§»åœ°å€æ‰©å……åˆ°32ä½
  2. é¡µä¼šä»£æ›¿æ®µ

- ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼

- å…¨å±€æè¿°ç¬¦è¡¨

  åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œå¯¹å†…å­˜çš„è®¿é—®ä»ç„¶ä½¿ç”¨æ®µåœ°å€å’Œåç§»åœ°å€ï¼Œä½†æ˜¯ï¼Œåœ¨æ¯ä¸ªæ®µèƒ½å¤Ÿè®¿é—®ä¹‹å‰ï¼Œå¿…é¡»å…ˆè¿›è¡Œç™»è®°ã€‚
  è¿™ç§æƒ…å†µå¥½æœ‰ä¸€æ¯”ã€‚å°±åƒæ˜¯å¼€å…¬å¸åšç”Ÿæ„ï¼Œåœ¨å®æ¨¡å¼ä¸‹ï¼Œå¼€å…¬å¸ä¸éœ€è¦ç™»è®°ï¼Œå–ä»€ä¹ˆéƒ½æ²¡æœ‰äººç®¡ï¼Œéšæ—¶éƒ½å¯ä»¥å¼€å¼ ã€‚ä½†åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†ï¼Œå¼€å…¬å¸ä¹‹å‰å¿…é¡»å…ˆç™»è®°ï¼Œç™»è®°çš„ä¿¡æ¯åŒ…æ‹¬ä½å€ï¼ˆæ®µçš„èµ·å§‹åœ°å€ï¼‰ã€ç»è¥é¡¹ç›®ï¼ˆæ®µçš„ç•Œé™ç­‰å„ç§è®¿é—®å±æ€§ï¼‰ã€‚è¿™æ ·ï¼Œæ¯å½“ä½ åšçš„ä¹°å–å’Œé¡¹ç›®ä¸ç¬¦æ—¶ï¼Œå°±ä¼šè¢«é˜»æ­¢ã€‚å¯¹æ®µçš„è®¿é—®ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå½“ä½ è®¿é—®çš„åç§»åœ°å€è¶…å‡ºæ®µçš„ç•Œé™æ—¶ï¼Œå¤„ç†å™¨å°±ä¼šé˜»æ­¢è¿™ç§è®¿é—®ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªå«åšå†…éƒ¨å¼‚å¸¸çš„ä¸­æ–­ã€‚

  æ®µæœ‰å…³çš„ä¿¡æ¯ç”¨8å­—èŠ‚æ¥æè¿°ï¼Œç§°ä¸ºSegment Descriptor,æ¯ä¸ªæ®µéƒ½éœ€è¦ä¸€ä¸ªæè¿°ä»˜ï¼Œåœ¨å†…å­˜ä¸­å¼€è¾Ÿä¸€æ®µç©ºé—´ç”¨æ¥å­˜æ”¾è¿™äº›æè¿°ç¬¦ï¼Œæ„æˆäº†æè¿°ç¬¦è¡¨ã€‚

  åœ¨è¿›å…¥ä¿æŠ¤æ¨¡å¼å‰ï¼Œå¿…é¡»è¦å®šä¹‰å¥½å…¨å±€æè¿°ç¬¦è¡¨(Global Descriptor Table)ã€‚

  ä¸ºäº†è·Ÿè¸ªå…¨å±€æè¿°ç¬¦è¡¨ï¼Œæœ‰ä¸€ä¸ª48ä½çš„å¯„å­˜å™¨ï¼Œç§°ä¸ºå…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨(GDTR)ï¼Œå¯„å­˜å™¨å¯åˆ†ä¸ºä¸¤éƒ¨åˆ†(ä¸€éƒ¨åˆ†æ˜¯32ä½ï¼Œä¸€éƒ¨åˆ†æ˜¯16ä½)

  GDTçš„ç•Œé™æ˜¯16ä½ï¼Œå³64KBï¼Œä¸€ä¸ªæè¿°ç¬¦å ç”¨8å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€å…±å¯ä»¥å®šä¹‰8192ä¸ªæè¿°ç¬¦

  ç”±äºè¿›å…¥ä¿æŠ¤æ¨¡å¼åï¼Œå¤„ç†å™¨ç«‹å³è¦æŒ‰ç…§æ–°çš„å†…å­˜è®¿é—®æ¨¡å¼å·¥ä½œï¼Œæ‰€ä»¥ï¼Œå¿…é¡»åœ¨è¿›å…¥ä¿æŠ¤æ¨¡å¼å‰å®šä¹‰GDTï¼Œä½†æ˜¯æ˜¯å®æ¨¡å¼ä¸‹åªèƒ½è®¿é—®1MBçš„å†…å­˜ï¼Œæ‰€ä»¥é€šå¸¸GDTå®šä¹‰åœ¨1MBçš„å†…å­˜èŒƒå›´å†…


#### åŠ è½½é¡ºåº

1. 6.828æˆ‘ä»¬å°†ä½¿ç”¨ä¼ ç»Ÿçš„åŠ è½½æœºåˆ¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„åŠ è½½å¯åŠ¨ä¸­å¿…é¡»æœ‰512bytesï¼Œå¼•å¯¼åŠ è½½ç¨‹åºç”±ä¸€ä¸ªæ±‡ç¼–æºä»£ç `boot/boot.S`å’ŒCçš„æºä»£ç `boot/main.c`æ¥è€ƒè™‘ï¼Œä»”ç»†çœ‹è¿™äº›æºæ–‡ä»¶ï¼Œç¡®å®šç†è§£äº†æ—¶å¦‚ä½•è¿è¡Œçš„ã€‚

   å¼•å¯¼åŠ è½½ç¨‹åºä»å®æ¨¡å¼è½¬æ¢ä¸º32ä½ä¿æŠ¤æ¨¡å¼ï¼Œå› ä¸ºåªæœ‰åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œå¯»å€æ‰èƒ½è¶…è¿‡1M

æ±‡ç¼–è¯­è¨€çš„é˜…è¯»

1. A20åªæœ‰20æ ¹åœ°å€çº¿ï¼Œæ‰€ä»¥å¯»å€èƒ½åŠ›ä¸º1Mä»¥å†…ï¼Œå½“è¶…è¿‡æ—¶å°†ä»0å¼€å§‹ã€‚

2. ä»å®æ¨¡å¼è½¬æ¢ä¸ºä¿æŠ¤æ¨¡å¼ï¼Œä½¿ç”¨GDT(å…¨å±€æè¿°ç¬¦è¡¨)å’Œæ®µç¿»è¯‘å™¨æ˜¯è™šæ‹Ÿåœ°å€ä»ç‰©ç†åœ°ä¸­æ€»å®šä¹‰ï¼Œä½¿æœ‰æ•ˆæ˜ å°„åœ¨äº¤æ¢æœŸé—´ä¸ä¼šæ›´æ”¹ã€‚

3. åˆ‡æ¢åˆ°  32ä½æ¨¡å¼

4. è°ƒç”¨bootmain(å†™çš„Cè¯­è¨€çš„ä»£ç ),å¦‚æœè¿”å›äº†ï¼Œå¾ªç¯

boot.Så’Œ main.Cæ˜¯å¯åŠ¨ç¨‹åºï¼Œä¼šè¢«å­˜æ”¾åœ¨ç£ç›˜çš„ç¬¬ä¸€æ‰‡åŒºï¼Œç¬¬äºŒä¸ªæ‰‡åŒºç”¨æ¥æ”¾æ ¸å¿ƒçš„é•œåƒ(æ ¸å¿ƒé•œåƒå¿…é¡»è¦æ˜¯ELFæ ¼å¼)

å¯åŠ¨æ­¥éª¤ï¼š

1. å½“CPUåœ¨å†…å­˜ä¸­ä¸­åŠ è½½åˆ°BIOSï¼Œç„¶åæ‰§è¡Œ
2. BIOSåˆå§‹åŒ–è®¾å¤‡ï¼Œä¸­æ–­å†ç¨‹é›†ï¼Œä»å¯åŠ¨è®¾å¤‡ä¸Šè¯»å–ç¬¬ä¸€æ‰‡åŒº
3. å‡è®¾å¼•å¯¼åŠ è½½ç¨‹åºå­˜å‚¨åœ¨ç¬¬ä¸€æ‰‡åŒºï¼Œç„¶åæ‰§è¡Œæƒç»™ä»£ç æ¥ç®¡
4. ä»boot.Sè·å–æ§åˆ¶æƒ--è®¾ç½®ä¿æŠ¤æ¨¡å¼å’Œå †ï¼Œä½¿å¾—Cå¯ä»¥æ‰§è¡Œï¼Œç„¶åè°ƒç”¨bootmain()
5. æ‰§è¡Œbootmain()
6.  å¼•å¯¼åŠ è½½ç¨‹åºé€šè¿‡ x86's ç‰¹æ®Š i/o æŒ‡ä»¤ç›´æ¥è®¿é—® IDE ç£ç›˜è®¾å¤‡å¯„å­˜å™¨, ä»ç¡¬ç›˜è¯»å–å†…æ ¸ã€‚è¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰åˆ†é¡µ

ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼çš„åˆ‡æ¢

`lgdtl`åŠ è½½å…¨å±€æè¿°ç¬¦

æ‰“å¼€ä¿æŠ¤æ¨¡å¼ï¼š

```
movl    %cr0, %eax
orl     $CR0_PE_ON, %eax
movl    %eax, %cr0
```

è·³è½¬åˆ°32ä½ä»£ç å¼€å§‹åœ°å€

debug

> After you understand the boot loader source code, look at the file `obj/boot/boot.asm`. This file is a disassembly of the boot loader that our GNUmakefile creates *after* compiling the boot loader. This disassembly file makes it easy to see exactly where in physical memory all of the boot loader's code resides, and makes it easier to track what's happening while stepping through the boot loader in GDB. Likewise, `obj/kern/kernel.asm` contains a disassembly of the JOS kernel, which can often be useful for debugging.



#### åŠ è½½å†…æ ¸

1. å¤ä¹ äº†ä¸€ä¸‹å…³äºæŒ‡é’ˆçš„çŸ¥è¯†

2. å­¦ä¹ äº†å…³äºé“¾æ¥çš„çŸ¥è¯†

3. æŸ¥çœ‹josçš„æ ¸å¿ƒä¿¡æ¯

   ```shell
   jos@jos-VirtualBox:~/6.828/lab$ objdump -h obj/kern/kernel
   
   obj/kern/kernel:     file format elf32-i386
   
   Sections:
   Idx Name          Size      VMA       LMA       File off  Algn
     0 .text         00001871  f0100000  00100000  00001000  2**4
                     CONTENTS, ALLOC, LOAD, READONLY, CODE
     1 .rodata       00000714  f0101880  00101880  00002880  2**5
                     CONTENTS, ALLOC, LOAD, READONLY, DATA
     2 .stab         000038d1  f0101f94  00101f94  00002f94  2**2
                     CONTENTS, ALLOC, LOAD, READONLY, DATA
     3 .stabstr      000018bb  f0105865  00105865  00006865  2**0
                     CONTENTS, ALLOC, LOAD, READONLY, DATA
     4 .data         0000a300  f0108000  00108000  00009000  2**12
                     CONTENTS, ALLOC, LOAD, DATA
     5 .bss          00000648  f0112300  00112300  00013300  2**5
                     CONTENTS, ALLOC, LOAD, DATA
     6 .comment      00000034  00000000  00000000  00013948  2**0
   
   ```

   `objdump`å‘½ä»¤æ˜¯Linuxä¸‹çš„åæ±‡ç¼–ç›®æ ‡æ–‡ä»¶æˆ–å¯æ‰§è¡Œæ–‡ä»¶çš„å‘½ä»¤ï¼Œå¯¹äºELFæ ¼å¼å¯æ‰§è¡Œæ–‡ä»¶ï¼Œ`objdump -h`æ˜¾ç¤ºæ–‡ä»¶çš„Section Headerçš„ä¿¡æ¯ï¼Œå…¶ä¸­æœ€ä¸ºé‡è¦çš„ä¿¡æ¯æ˜¯VMA(Virtual Memory Address) å’ŒLMA(Load Memory Address),è¿™ä¸ªåœ°å€å°±æ˜¯åŠ è½½åˆ°å†…å­˜çš„åœ°å€ã€‚

   ```shell
   jos@jos-VirtualBox:~/6.828/lab$ objdump -x obj/kern/kernel
   ##å…¶ä¸­çš„ç¨‹åºå¤´éƒ¨è¡¨
   Program Header:
       LOAD off    0x00001000 vaddr 0xf0100000 paddr 0x00100000 align 2**12
            filesz 0x00007120 memsz 0x00007120 flags r-x
       LOAD off    0x00009000 vaddr 0xf0108000 paddr 0x00108000 align 2**12
            filesz 0x0000a948 memsz 0x0000a948 flags rw-
      STACK off    0x00000000 vaddr 0x00000000 paddr 0x00000000 align 2**4
            filesz 0x00000000 memsz 0x00000000 flags rwx
            
   ## off:ç›®æ ‡æ–‡ä»¶ä¸­çš„åç§»é‡
   ## vaddrï¼šè™šæ‹Ÿå†…å­˜ï¼Œpaddrï¼šç‰©ç†å†…å­˜   å†…å­˜åœ°å€
   ## align: å¯¹é½è¦æ±‚ 
   ## filesz: ç›®æ ‡æ–‡ä»¶ä¸­çš„æ®µå¤§å°
   ## memsz: å†…å­˜ä¸­çš„æ®µå¤§å°
   ## flags:è¿è¡Œæ—¶è®¿é—®æƒé™
   ```

   ELFå¯æ‰§è¡Œæ–‡ä»¶è¢«è®¾è®¡å¾—å¾ˆå®¹æ˜“åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¯æ‰§è¡Œæ–‡ä»¶çš„è¿ç»­çš„ç‰‡è¢«æ˜ å°„åˆ°è¿ç»­çš„å†…å­˜æ®µä¸­ï¼Œç¨‹åºå¤´éƒ¨è¡¨å°±è¡¨è¿°äº†è¿™ç§æ˜ å°„å…³ç³»ã€‚

   ```shell
   
   jos@jos-VirtualBox:~/6.828/lab$ objdump -h obj/boot/boot.out
   
   obj/boot/boot.out:     file format elf32-i386
   
   Sections:
   Idx Name          Size      VMA       LMA       File off  Algn
     0 .text         00000186  00007c00  00007c00  00000074  2**2
                     CONTENTS, ALLOC, LOAD, CODE
     1 .eh_frame     000000a8  00007d88  00007d88  000001fc  2**2
                     CONTENTS, ALLOC, LOAD, READONLY, DATA
     2 .stab         00000720  00000000  00000000  000002a4  2**2
                     CONTENTS, READONLY, DEBUGGING
     3 .stabstr      0000088f  00000000  00000000  000009c4  2**0
                     CONTENTS, READONLY, DEBUGGING
     4 .comment      00000034  00000000  00000000  00001253  2**0
                     CONTENTS, READONLY
   
   ```

   ä»è¿™é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œboot sectoråœ¨å†…å­˜ä¸­çš„å¼€å§‹åœ°å€æ˜¯0x7c00,é€šè¿‡ELF program headerså†³å®šäº†å¦‚ä½•åŠ è½½å—ï¼Œè®©æˆ‘ä»¬å†å›åˆ°boot/main.c

   ```shell
        // load each program segment (ignores ph flags)
           ph = (struct Proghdr *) ((uint8_t *) ELFHDR + ELFHDR->e_phoff);
           eph = ph + ELFHDR->e_phnum;
           for (; ph < eph; ph++)
                   // p_pa is the load address of this segment (as well
                   // as the physical address)
                   readseg(ph->p_pa, ph->p_memsz, ph->p_offset);
   ```

   `readseg(ph->p_pa, ph->p_memsz, ph->p_offset)`å°±æ˜¯è¯»å–program headersé‡Œé¢çš„ç‰©ç†åœ°å€å’Œå†…å­˜ä¸­æ®µå¤§å°è¿˜æœ‰åç§»åœ°å€ï¼Œç”¨readsegç”¨æ¥åŠ è½½å„ä¸ªå—ã€‚

   ##### Exercise5

   ä¿®æ”¹boot/Makefragé‡Œé¢çš„ -Ttext 0x7c00ï¼Œä½†æ˜¯æ²¡æœ‰æƒé™ï¼Œæˆ‘æ²¡åŠæ³•ä¿®æ”¹æ–‡ä»¶ã€‚

   å›å¤´çœ‹æ ¸å¿ƒçš„åŠ è½½åœ°å€çš„é“¾æ¥åœ°å€ï¼Œè¿™ä¸¤ä¸ªåœ°å€ä¸åŒ:æ ¸å¿ƒå‘Šè¯‰å¼•å¯¼åŠ è½½ç¨‹åºè®°è½½åœ¨å†…å­˜çš„ä½åœ°å€ï¼Œä½†æ˜¯å´æœŸæœ›æ‰§è¡Œåœ¨é«˜åœ°å€ï¼Œ

   é™¤äº†sectionä¿¡æ¯ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„æ–‡ä»¶åœ¨ELF headerï¼Œåå­—æ˜¯`e_entry`,è¿™ä¸ªæ–‡ä»¶æ˜¯ç¨‹åºçš„å…¥å£ï¼š

   ```shell
   
   jos@jos-VirtualBox:~/6.828/lab/obj/kern$ objdump -f kernel
   
   kernel:     file format elf32-i386
   architecture: i386, flags 0x00000112:
   EXEC_P, HAS_SYMS, D_PAGED
   start address 0x0010000c
   ```

   è®©æˆ‘ä»¬æ¥å¯¹åº”äºæ–‡ä»¶`/obj/kern/kern.asm`

   ```shell
   .globl entry
   entry:
           movw    $0x1234,0x472                   # warm boot
   f0100000:       02 b0 ad 1b 00 00       add    0x1bad(%eax),%dh
   f0100006:       00 00                   add    %al,(%eax)
   f0100008:       fe 4f 52                decb   0x52(%edi)
   f010000b:       e4                      .byte 0xe4
   
   f010000c <entry>:
   f010000c:       66 c7 05 72 04 00 00    movw   $0x1234,0x472
   f0100013:       34 12
   ```

   è¿™ä¸ªå³å‡½æ•°çš„å…¥å£ç‚¹ï¼Œå³bootmainå‡½æ•°çš„å…¥å£ç‚¹ï¼Œå®ƒè¯»å–å†…æ ¸çš„æ¯ä¸ªéƒ¨åˆ†ä»ç£ç›˜åˆ°å†…å­˜åœ¨èŠ‚çš„åŠ è½½åœ°å€, ç„¶åè·³è½¬åˆ°å†…æ ¸çš„å…¥å£ç‚¹ã€‚ğŸ˜­æœ‰ç–‘é—®å‘€

   > æ²¡æœ‰æ‡‚ï¼šReset the machine (exit QEMU/GDB and start them again). Examine the 8 words of memory at 0x00100000 at the point the BIOS enters the boot loader, and then again at the point the boot loader enters the kernel. Why are they different? What is there at the second breakpoint? (You do not really need to use QEMU to answer this question. Just think.)

### Part3:The Kernel

ç°åœ¨æˆ‘ä»¬å¼€å§‹è§æ£€æŸ¥JOSæ ¸å¿ƒçš„ä¸€äº›ç»†èŠ‚ï¼Œæ ¸å¿ƒå¯åŠ¨çš„æ—¶å€™æ±‡ç¼–è¯­è¨€å…ˆå¯¹å‡†å¤‡Cè¯­è¨€èƒ½å¤Ÿæ‰§è¡Œçš„ç¯å¢ƒã€‚

#### ä½¿ç”¨è™šæ‹Ÿå†…å­˜

- åŸºç¡€çŸ¥è¯†

  ##### å®æ¨¡å¼(real mode)

  ã€€ã€€å®æ¨¡å¼å‡ºç°äºæ—©æœŸ8088CPUæ—¶æœŸã€‚å½“æ—¶ç”±äºCPUçš„æ€§èƒ½æœ‰é™ï¼Œä¸€å…±åªæœ‰20ä½åœ°å€çº¿ï¼ˆæ‰€ä»¥åœ°å€ç©ºé—´åªæœ‰1MBï¼‰ï¼Œä»¥åŠ8ä¸ª16ä½çš„é€šç”¨å¯„å­˜å™¨ï¼Œä»¥åŠ4ä¸ª16ä½çš„æ®µå¯„å­˜å™¨ã€‚æ‰€ä»¥ä¸ºäº†èƒ½å¤Ÿé€šè¿‡è¿™äº›16ä½çš„å¯„å­˜å™¨å»æ„æˆ20ä½çš„ä¸»å­˜åœ°å€ï¼Œå¿…é¡»é‡‡å–ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼ã€‚å½“æŸä¸ªæŒ‡ä»¤æƒ³è¦è®¿é—®æŸä¸ªå†…å­˜åœ°å€æ—¶ï¼Œå®ƒé€šå¸¸éœ€è¦ç”¨ä¸‹é¢çš„è¿™ç§æ ¼å¼æ¥è¡¨ç¤ºï¼š

  ã€€ã€€(æ®µåŸºå€ï¼šæ®µåç§»é‡)

  ã€€ã€€å…¶ä¸­ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯æ®µåŸºå€ï¼Œå®ƒçš„å€¼æ˜¯ç”±æ®µå¯„å­˜å™¨æä¾›çš„ã€‚æ®µå¯„å­˜å™¨æœ‰4ç§ï¼Œ%csï¼Œ%dsï¼Œ%ssï¼Œ%esã€‚å…·ä½“è¿™ä¸ªæŒ‡ä»¤é‡‡ç”¨å“ªä¸ªæ®µå¯„å­˜å™¨æ˜¯ç”±è¿™ä¸ªæŒ‡ä»¤çš„ç±»å‹æ¥å†³å®šçš„ã€‚æ¯”å¦‚è¦å–æŒ‡ä»¤å°±æ˜¯é‡‡ç”¨%cså¯„å­˜å™¨ï¼Œè¦è¯»å–æˆ–å†™å…¥æ•°æ®å°±æ˜¯%dså¯„å­˜å™¨ï¼Œå¦‚æœè¦å¯¹å †æ ˆæ“ä½œå°±æ˜¯%sså¯„å­˜å™¨ã€‚æ€»ä¹‹ï¼Œä¸ç®¡ä»€ä¹ˆæŒ‡ä»¤ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªæ®µå¯„å­˜å™¨æä¾›ä¸€ä¸ª16ä½çš„æ®µåŸºå€ã€‚

  ã€€ã€€ç¬¬äºŒå­—æ®µæ˜¯æ®µå†…åç§»é‡ï¼Œä»£è¡¨ä½ è¦è®¿é—®çš„è¿™ä¸ªå†…å­˜åœ°å€è·ç¦»è¿™ä¸ªæ®µåŸºå€çš„åç§»ã€‚å®ƒçš„å€¼å°±æ˜¯ç”±é€šç”¨å¯„å­˜å™¨æ¥æä¾›çš„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯16ä½ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸¤ä¸ª16ä½çš„å€¼å¦‚ä½•ç»„åˆæˆä¸€ä¸ª20ä½çš„åœ°å€å‘¢ï¼Ÿè¿™é‡Œé‡‡ç”¨çš„æ–¹å¼æ˜¯æŠŠæ®µå¯„å­˜å™¨æ‰€æä¾›çš„æ®µåŸºå€å…ˆå‘å·¦ç§»4ä½ã€‚è¿™æ ·å°±å˜æˆäº†ä¸€ä¸ª20ä½çš„å€¼ï¼Œç„¶åå†ä¸æ®µåç§»é‡ç›¸åŠ ã€‚æ‰€ä»¥ç®—æ³•å¦‚ä¸‹ï¼š

  ã€€ã€€ç‰©ç†åœ°å€ = æ®µåŸºå€<<4 + æ®µå†…åç§»

  ã€€ã€€æ‰€ä»¥å‡è®¾ %csä¸­çš„å€¼æ˜¯0xff00ï¼Œ%ax = 0x0110ã€‚åˆ™(%cs:%ax)è¿™ä¸ªåœ°å€å¯¹åº”çš„çœŸå®ç‰©ç†åœ°å€æ˜¯ 0xff00<<4 + 0x0110 = 0xff110ã€‚

  ã€€ã€€ä¸Šé¢å°±æ˜¯å®æ¨¡å¼è®¿é—®å†…å­˜åœ°å€çš„åŸç†ã€‚

   

  ##### ä¿æŠ¤æ¨¡å¼(protected mode)

  ã€€ã€€ä½†æ˜¯éšç€CPUçš„å‘å±•ï¼ŒCPUçš„åœ°å€çº¿çš„ä¸ªæ•°ä¹Ÿä»åŸæ¥çš„20æ ¹å˜ä¸ºç°åœ¨çš„32æ ¹ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—®çš„å†…å­˜ç©ºé—´ä¹Ÿä»1MBå˜ä¸ºç°åœ¨4GBï¼Œå¯„å­˜å™¨çš„ä½æ•°ä¹Ÿå˜ä¸º32ä½ã€‚æ‰€ä»¥å®æ¨¡å¼ä¸‹çš„å†…å­˜åœ°å€è®¡ç®—æ–¹å¼å°±å·²ç»ä¸å†é€‚åˆäº†ã€‚æ‰€ä»¥å°±å¼•å…¥äº†ç°åœ¨çš„ä¿æŠ¤æ¨¡å¼ï¼Œå®ç°æ›´å¤§ç©ºé—´çš„ï¼Œæ›´çµæ´»çš„å†…å­˜è®¿é—®ã€‚

  ã€€ã€€åœ¨ä»‹ç»ä¿æŠ¤æ¨¡å¼çš„å·¥ä½œåŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆæ¸…æ¥šä»¥ä¸‹å‡ ä¸ªå®¹æ˜“æ··æ·†çš„æ¦‚å¿µã€‚é€»è¾‘åœ°å€(logical address)ï¼Œè™šæ‹Ÿåœ°å€(virtual address)ï¼Œçº¿æ€§åœ°å€(linear address)ï¼Œç‰©ç†åœ°å€(physical address)ã€‚

  ã€€ã€€æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¦‚ä»Šåœ¨ç¼–å†™ç¨‹åºæ—¶ï¼Œç¨‹åºæ—¶è¿è¡Œåœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸‹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¨‹åºå‘˜ç¼–å†™ç¨‹åºæ—¶æŒ‡ä»¤ä¸­å‡ºç°çš„åœ°å€å¹¶ä¸ä¸€å®šæ—¶è¿™ä¸ªç¨‹åºåœ¨å†…å­˜ä¸­è¿è¡Œæ—¶çœŸæ­£è¦è®¿é—®çš„å†…å­˜åœ°å€ã€‚è¿™æ ·åšçš„ç›®çš„å°±æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©ç¨‹åºå‘˜åœ¨ç¼–ç¨‹æ—¶ä¸éœ€è¦ç›´æ¥æ“ä½œçœŸå®åœ°å€ï¼Œå› ä¸ºå½“å®ƒåœ¨çœŸå®è¿è¡Œæ—¶ï¼Œå†…å­˜ä¸­å„ä¸ªç¨‹åºçš„åˆ†å¸ƒæƒ…å†µæ˜¯ä¸å¯èƒ½åœ¨ä½ ç¼–å†™ç¨‹åºæ—¶å°±çŸ¥é“çš„ã€‚æ‰€ä»¥è¿™ä¸ªç¨‹åºçš„è¿™æ¡æŒ‡ä»¤åˆ°åº•è¦è®¿é—®å“ªä¸ªå†…å­˜å•å…ƒæ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥ç¡®å®šçš„ã€‚æ‰€ä»¥è¿™å°±æ˜¯ä¸€ä¸ªä»è™šæ‹Ÿåœ°å€(virtual address)åˆ°çœŸå®ä¸»å­˜ä¸­çš„ç‰©ç†åœ°å€(physical address)çš„è½¬æ¢ã€‚

  ã€€ã€€é‚£ä¹ˆé€»è¾‘åœ°å€(logical address)åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ ¹æ®ä¸Šé¢ä¸€æ®µæ–‡å­—æˆ‘ä»¬çŸ¥é“ï¼Œç¨‹åºå‘˜ç¼–å†™æ—¶çœ‹åˆ°çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯è¯´ç¨‹åºå‘˜æ˜¯ç›´æ¥æŠŠè¿™ä¸ªè™šæ‹Ÿåœ°å€å†™åˆ°æŒ‡ä»¤ä¸­çš„ã€‚å®ƒæ˜¯ç”±é€»è¾‘åœ°å€æ¨å¯¼å¾—åˆ°çš„ã€‚æ‰€ä»¥æŒ‡ä»¤ä¸­çœŸå®å‡ºç°çš„æ˜¯é€»è¾‘åœ°å€ã€‚ä¸€ä¸ªé€»è¾‘åœ°å€æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼Œä¸€ä¸ªæ®µé€‰æ‹©å­(segment selector)ï¼Œä¸€ä¸ªæ®µå†…åç§»é‡(offset)ï¼Œé€šå¸¸è¢«å†™ä½œsegment:offsetã€‚è€Œä¸”é‡‡ç”¨å“ªä¸ªæ®µé€‰æ‹©å­é€šå¸¸ä¹Ÿæ˜¯åœ¨æŒ‡ä»¤ä¸­éšå«çš„ï¼Œç¨‹åºå‘˜é€šå¸¸åªéœ€è¦æŒ‡æ˜æ®µå†…åç§»é‡ã€‚ç„¶ååˆ†æ®µç®¡ç†æœºæ„(segmentation hardware)å°†ä¼šæŠŠè¿™ä¸ªé€»è¾‘åœ°å€è½¬æ¢ä¸ºçº¿æ€§åœ°å€(linear address)ã€‚å¦‚æœè¯¥æœºå™¨æ²¡æœ‰é‡‡ç”¨åˆ†é¡µæœºåˆ¶(paging hardware)çš„è¯ï¼Œæ­¤æ—¶linear addresså°±æ˜¯æœ€åçš„ä¸»å­˜ç‰©ç†åœ°å€ã€‚ä½†æ˜¯å¦‚æœæœºå™¨ä¸­è¿˜æœ‰åˆ†é¡µè®¾å¤‡çš„è¯ï¼Œæ¯”å¦‚å†…å­˜å¤§å°å®é™…åªæœ‰1Gï¼Œä½†æ˜¯æ ¹æ®å‰é¢æˆ‘ä»¬çŸ¥é“å¯è®¿é—®çš„ç©ºé—´æœ‰4Gã€‚æ‰€ä»¥æ­¤æ—¶è¿˜éœ€è¦åˆ†é¡µæœºæ„(paging hardware)æŠŠè¿™ä¸ªçº¿æ€§åœ°å€è½¬æ¢ä¸ºæœ€ç»ˆçš„çœŸå®ç‰©ç†åœ°å€ã€‚æ‰€ä»¥å¯è§è™šæ‹Ÿåœ°å€å’Œçº¿æ€§åœ°å€çš„å«ä¹‰æ˜¯å·®ä¸å¤šçš„ã€‚æˆ‘ä»¬å¯ä»¥å†ä¸‹å›¾ä¸­çœ‹åˆ°æˆ‘ä»¬ä¸Šé¢å™è¿°çš„åœ°å€è½¬æ¢è¿‡ç¨‹ã€‚åœ¨boot loaderä¸­ï¼Œå¹¶æ²¡æœ‰å¼€å¯åˆ†é¡µæœºæ„ã€‚æ‰€ä»¥è®¡ç®—å‡ºæ¥çš„çº¿æ€§åœ°å€å°±æ˜¯çœŸå®è¦è®¿é—®çš„ä¸»å­˜åœ°å€ã€‚

  ã€€ã€€![img](https://images2015.cnblogs.com/blog/809277/201601/809277-20160109142207371-383459687.png)

  ã€€ã€€é‚£ä¹ˆåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•é€šè¿‡segment:offsetæœ€ç»ˆå¾—åˆ°ç‰©ç†åœ°å€çš„å‘¢ï¼Ÿ

  ã€€ã€€é¦–å…ˆï¼Œåœ¨è®¡ç®—æœºä¸­å­˜åœ¨ä¸¤ä¸ªè¡¨ï¼ŒGDTï¼ŒLDTã€‚å®ƒä»¬ä¸¤ä¸ªå…¶å®æ˜¯åŒç±»å‹çš„è¡¨ï¼Œå‰è€…å«åšå…¨å±€æ®µæè¿°ç¬¦è¡¨ï¼Œåè€…å«åšæœ¬åœ°æ®µæè¿°ç¬¦è¡¨ã€‚ä»–ä»¬éƒ½æ˜¯ç”¨æ¥å­˜æ”¾å…³äºæŸä¸ªè¿è¡Œåœ¨å†…å­˜ä¸­çš„ç¨‹åºçš„åˆ†æ®µä¿¡æ¯çš„ã€‚æ¯”å¦‚æŸä¸ªç¨‹åºçš„ä»£ç æ®µæ˜¯ä»å“ªé‡Œå¼€å§‹ï¼Œæœ‰å¤šå¤§ï¼›æ•°æ®æ®µåˆæ˜¯ä»å“ªé‡Œå¼€å§‹ï¼Œæœ‰å¤šå¤§ã€‚GDTè¡¨æ˜¯å…¨å±€å¯è§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªè¿è¡Œåœ¨å†…å­˜ä¸­çš„ç¨‹åºéƒ½èƒ½çœ‹åˆ°è¿™ä¸ªè¡¨ã€‚æ‰€ä»¥æ“ä½œç³»ç»Ÿå†…æ ¸ç¨‹åºçš„æ®µä¿¡æ¯å°±å­˜åœ¨è¿™é‡Œé¢ã€‚è¿˜æœ‰ä¸€ä¸ªLDTè¡¨ï¼Œè¿™ä¸ªè¡¨æ˜¯æ¯ä¸€ä¸ªåœ¨å†…å­˜ä¸­çš„ç¨‹åºéƒ½åŒ…å«çš„ï¼Œé‡Œé¢æŒ‡æ˜äº†æ¯ä¸€ä¸ªç¨‹åºçš„æ®µä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªè¡¨çš„ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

  ã€€ã€€![img](https://images2015.cnblogs.com/blog/809277/201601/809277-20160109143519184-1430449279.png)

  ã€€ã€€æˆ‘ä»¬ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯GDTï¼Œè¿˜æ˜¯LDTã€‚æ¯ä¸€ä¸ªè¡¨é¡¹éƒ½åŒ…æ‹¬ä¸‰ä¸ªå­—æ®µï¼š

  ã€€ã€€Base : 32ä½ï¼Œä»£è¡¨è¿™ä¸ªç¨‹åºçš„è¿™ä¸ªæ®µçš„åŸºåœ°å€ã€‚

  ã€€ã€€Limit : 20ä½ï¼Œä»£è¡¨è¿™ä¸ªç¨‹åºçš„è¿™ä¸ªæ®µçš„å¤§å°ã€‚

  ã€€ã€€Flags ï¼š12ä½ï¼Œä»£è¡¨è¿™ä¸ªç¨‹åºçš„è¿™ä¸ªæ®µçš„è®¿é—®æƒé™ã€‚

  ã€€ã€€å½“ç¨‹åºä¸­ç»™å‡ºé€»è¾‘åœ°å€ segment:offsetæ—¶ï¼Œä»–å¹¶ä¸æ˜¯åƒå®æ¨¡å¼é‚£æ ·ï¼Œç”¨segmentçš„å€¼ä½œä¸ºæ®µåŸºå€ã€‚è€Œæ˜¯æŠŠè¿™ä¸ªsegmentçš„å€¼ä½œä¸ºä¸€ä¸ªselectorï¼Œä»£è¡¨è¿™ä¸ªæ®µçš„æ®µè¡¨é¡¹åœ¨GDT/LDTè¡¨çš„ç´¢å¼•ã€‚æ¯”å¦‚ä½ å½“å‰è¦è®¿é—®çš„åœ°å€æ˜¯segment:offset = 0x01:0x0000ffffï¼Œæ­¤æ—¶ç”±äºæ¯ä¸ªæ®µè¡¨é¡¹çš„é•¿åº¦ä¸º8ï¼Œæ‰€ä»¥æ­¤æ—¶åº”è¯¥å–å‡ºåœ°å€8å¤„çš„æ®µè¡¨é¡¹ã€‚ç„¶åé¦–å…ˆæ ¹æ®Flagså­—æ®µæ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥è®¿é—®è¿™ä¸ªæ®µçš„å†…å®¹ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†èƒ½å¤Ÿå®ç°è¿›ç¨‹é—´åœ°å€çš„ä¿æŠ¤ã€‚å¦‚æœèƒ½è®¿é—®ï¼Œåˆ™æŠŠBaseå­—æ®µçš„å†…å®¹å–å‡ºï¼Œç›´æ¥ä¸offsetç›¸åŠ ï¼Œå°±å¾—åˆ°çº¿æ€§åœ°å€(linear address)äº†ã€‚ä¹‹åå°±æ˜¯è¦æ ¹æ®æ˜¯å¦æœ‰åˆ†é¡µæœºæ„æ¥è¿›è¡Œåœ°å€è½¬æ¢äº†ã€‚

  ã€€ã€€æ¯”å¦‚å½“å‰Baseå­—æ®µçš„å€¼æ˜¯0x00f0000ï¼Œåˆ™æœ€åçº¿æ€§åœ°å€çš„å€¼ä¸º0x00f0ffffã€‚

  ã€€ã€€å¦‚ä¸Šæ‰€è¿°å°±æ˜¯ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œå†…å­˜åœ°å€çš„è®¡ç®—æ–¹æ³•ã€‚

  ã€€ã€€

  ã€€ã€€ç»¼è¿°ï¼Œé€šè¿‡ä¸Šé¢çš„å™è¿°å¯è§ï¼Œä¿æŠ¤æ¨¡å¼è¿˜æ˜¯è¦æ¯”å®æ¨¡å¼çš„å·¥ä½œæ–¹å¼çµæ´»è®¸å¤šï¼Œå¯ä»¥åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çœ‹å‡ºæ¥ï¼š

  ã€€ã€€1. å®æ¨¡å¼ä¸‹æ®µåŸºåœ°å€å¿…é¡»æ˜¯16çš„æ•´æ•°å€ï¼Œä¿æŠ¤æ¨¡å¼ä¸‹æ®µåŸºåœ°å€å¯ä»¥æ˜¯4GBç©ºé—´å†…çš„ä»»æ„ä¸€ä¸ªåœ°å€ã€‚

  ã€€ã€€2. å®æ¨¡å¼ä¸‹æ®µçš„é•¿åº¦æ˜¯65536Bï¼Œä½†æ˜¯ä¿æŠ¤æ¨¡å¼ä¸‹æ®µçš„é•¿åº¦ä¹Ÿæ˜¯å¯ä»¥è¾¾åˆ°4GBçš„ã€‚

  ã€€ã€€3. ä¿æŠ¤æ¨¡å¼ä¸‹å¯ä»¥å¯¹å†…å­˜çš„è®¿é—®å¤šåŠ ä¸€å±‚ä¿æŠ¤ï¼Œä½†æ˜¯å®æ¨¡å¼æ²¡æœ‰ã€‚

æ‘˜è‡ª:https://www.cnblogs.com/fatsheep9146/p/5116426.html



ä¹‹å‰åœ¨å¼•å¯¼ç¨‹åºåŠ è½½çš„åœ°å€çš„æ—¶å€™ï¼Œè¡¨ç°å¾—å¾ˆå¥½ï¼Œä½†æ˜¯æœ‰æ—¶å€™æ ¸å¿ƒçš„è™šæ‹Ÿåœ°å€å’Œå®è´¨åŠ è½½çš„åœ°å€ä¸ä¸€æ ·ï¼Œæ“ä½œç³»ç»Ÿæ ¸å¿ƒç»å¸¸é“¾æ¥å’Œè¿è¡Œåœ¨é«˜ä½çš„è™šæ‹Ÿåœ°å€ï¼Œæ¯”å¦‚è¯´ 0xf0100000,ä¸ºäº†æŠŠä½åœ°å€ç»™ç¨‹åºä½¿ç”¨ç»™ç¨‹åºä½¿ç”¨ã€‚å¾ˆå¤šæœºå™¨æ²¡æœ‰ 0xf0100000è¿™ä¸ªç‰©ç†åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½æŠŠæ ¸å¿ƒå­˜å‚¨åœ¨é‚£ï¼Œæˆ‘ä»¬ä¼šç”¨å¤„ç†å™¨çš„å†…å­˜ç®¡ç†ç¡¬ä»¶å»æ˜ å°„è™šæ‹Ÿåœ°å€0xf0100000åˆ°ç‰©ç†åœ°å€0x00100000ã€‚è¿™æ ·ï¼Œå°½ç®¡æ ¸å¿ƒçš„è™šæ‹Ÿåœ°å€è¶³å¤Ÿé«˜ï¼Œå¯ä»¥ç»™ç”¨æˆ·è¿›ç¨‹ç•™è¶³å¤Ÿçš„ç©ºé—´ï¼Œæ ¸å¿ƒå°†åŠ è½½åœ¨BIOSä¸Šé¢ä¸€ç‚¹çš„RAMå¤„ï¼Œè¿™ç§æ–¹æ³•è¦æ±‚ PC è‡³å°‘æœ‰å‡ å…†å­—èŠ‚çš„ç‰©ç†å†…å­˜ (ä»¥ä¾¿ç‰©ç†åœ°å€0x00100000 å·¥ä½œ), ä½†è¿™å¯èƒ½æ˜¯çœŸå®çš„ä»»ä½• PC åå»ºç«‹å¤§çº¦1990ã€‚

è§£å†³çš„æ–¹æ¡ˆé€šå¸¸æ˜¯é€šè¿‡åˆ†æ®µç®¡ç†,åˆ†é¡µç®¡ç†æ¥å®ç°çš„.

åœ¨è¿™ä¸ªå®éªŒä¸­,é‡‡ç”¨åˆ†é¡µç®¡ç†æ¥å®ç°ä¸Šé¢æ‰€è®²è¿°çš„åœ°å€æ˜ å°„,ç°åœ¨æˆ‘ä»¬æ˜ å°„ç¬¬ä¸€ä¸ª4MBçš„ç‰©ç†å†…å­˜ï¼Œè¶³å¤Ÿè®©æˆ‘ä»¬è¿è¡Œå’Œå¯åŠ¨ã€‚æˆ‘ä»¬ä½¿ç”¨æ‰‹å†™ï¼Œé™æ€åˆå§‹åŒ–é¡µé¢ç›®å½•å’Œ`kern/entrypgdir.c`é‡Œçš„é¡µè¡¨ã€‚ç°åœ¨ï¼Œä½ ä¸éœ€è¦ç†è§£å·¥ä½œçš„ç»†èŠ‚ï¼Œåªæ˜¯è¾¾åˆ°æ•ˆæœã€‚

Exercise 7:ä½¿ç”¨QEMUå’ŒGDBå»è·Ÿè¸ªJOSå†…æ ¸,åœ¨`movl %eax, %cr0`å‡ºæ–­ç‚¹

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹`kern/entry.S`

```
 # Load the physical address of entry_pgdir into cr3.  entry_pgdir
        # is defined in entrypgdir.c.
        movl    $(RELOC(entry_pgdir)), %eax
        movl    %eax, %cr3
        # Turn on paging.
        movl    %cr0, %eax
        orl     $(CR0_PE|CR0_PG|CR0_WP), %eax
        movl    %eax, %cr0
```

æŠŠç‰©ç†åœ°å€è½¬åŒ–ä¸ºè™šæ‹Ÿåœ°å€,å†æ¥çœ‹ä¸€ä¸‹ç¼–è¯‘åçš„æ–‡ä»¶,ä»¥ç¡®å®šæˆ‘ä»¬è¦åœ¨å“ªé‡Œæ‰“æ–­ç‚¹,`/obj/kern/kernel.asm`

```shell

        # Load the physical address of entry_pgdir into cr3.  entry_pgdir
        # is defined in entrypgdir.c.
        movl    $(RELOC(entry_pgdir)), %eax
f0100015:       b8 00 00 11 00          mov    $0x110000,%eax
        movl    %eax, %cr3
f010001a:       0f 22 d8                mov    %eax,%cr3
        # Turn on paging.
        movl    %cr0, %eax
f010001d:       0f 20 c0                mov    %cr0,%eax
        orl     $(CR0_PE|CR0_PG|CR0_WP), %eax
f0100020:       0d 01 00 01 80          or     $0x80010001,%eax
        movl    %eax, %cr0
f0100025:       0f 22 c0                mov    %eax,%cr0
```

æˆ‘ä»¬åœ¨f0100025æ‰“ä¸Šæ–­ç‚¹

```shell
(gdb) si
=> 0x100025:    mov    %eax,%cr0
0x00100025 in ?? ()
(gdb) x/4xb 0x00100000
0x100000:    0x02    0xb0    0xad    0x1b
(gdb) x/4xb 0xf0100000
0xf0100000 <_start+4026531828>:    0x00    0x00    0x00    0x00
(gdb) si
=> 0x100028:    mov    $0xf010002f,%eax
0x00100028 in ?? ()
(gdb) x/4xb 0x00100000
0x100000:    0x02    0xb0    0xad    0x1b
(gdb) x/4xb 0xf0100000
0xf0100000 <_start+4026531828>:    0x02    0xb0    0xad    0x1b
```



æˆ‘ä»¬å‘ç°,è¿™ä¸¤ä¸ªåœ°å€å­˜æ”¾çš„å€¼æ˜¯ä¸€æ ·çš„äº†,å¯è§åŸæœ¬å­˜æ”¾åœ¨,0xf0100000å¤„çš„å†…å®¹ï¼Œå·²ç»è¢«æ˜ å°„åˆ°0x00100000å¤„äº†.

å½“ç»§ç»­`si`,åˆ†é¡µå·²ç»å»ºç«‹äº†,ä½†æ˜¯æˆ‘ä»¬ä»ç„¶åœ¨